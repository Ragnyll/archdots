#!/bin/bash

# any failure in piped commands aborts pipe
set -o pipefail
# exit when any command fails
set -e
# Checking dependencies:
whereis lpass > /dev/null || echoexit "'lpass' not found."

function echoexit() {
    # Print to stderr and exit
    printf "$@" 1>&2
    exit 1
}

function menu() {
    # Menu command should read from stdin and write to stdout
    dmenu -p "Select"
}

function usage() {
    printf "Dynamic menu interface for lpass.

Usage:
  dmenu-lpass [-h]
    -h                                 Display this help message."
}

function select_service() {
    # lists all accounts
    local services="$(lpass ls --format %an | sort)"
    printf "$services" | menu
}

function select_username() {
    # $1 is the name of the service to list usernames for

    usernames="$(lpass show --username --expand-multi $1 | sort)"
    printf "$usernames" | menu
}

function copy_password() {
    # $1 is the service name
    # $2 is the account name

    # i dunno why, but for services with more than 1 account both passwords are listed
    # not sure how to deal with that
    lpass show --clip --password $1 $2 | head -n 1
}

function copy-account-field() {
  lpass show --clip "--${2}" "$1" >/dev/null 2>/dev/null
}

service=$(select_service)
username=$(select_username $service)
copy_password $service $username
